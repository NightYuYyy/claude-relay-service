# Claude Relay Service 按模型限额功能需求文档

## 1. 需求概述

### 1.1 需求背景
当前系统只支持整体每日费用限额(`dailyCostLimit`)，无法为不同AI平台和模型设置独立的费用控制，缺乏精细化的成本管理能力。

### 1.2 需求目标
实现按平台和具体模型的费用限额配置，提供更灵活的成本控制机制。

## 2. 功能需求

### 2.1 核心功能
- **平台级限额控制**：支持Claude、OpenAI、Gemini等平台独立限额设置
- **模型级限额控制**：支持具体模型（如GPT-4、Claude Opus）的独立限额
- **多维度限额组合**：支持每日、每周等不同时间维度的限额配置
- **限额状态查询**：实时查看各平台/模型的费用使用情况

### 2.2 功能特性
1. **灵活配置**
   - 支持启用/禁用特定平台限额
   - 支持启用/禁用特定模型限额
   - 支持设置0值表示无限制

2. **多重验证**
   - 整体限额（兜底机制）
   - 平台级限额验证
   - 模型级限额验证
   - 按优先级依次检查

3. **向下兼容**
   - 保留现有`dailyCostLimit`功能
   - 保留现有`weeklyOpusCostLimit`功能
   - 新功能为增量特性

## 3. 数据结构设计

### 3.1 API Key扩展字段
```javascript
{
  // === 现有字段（保持不变） ===
  dailyCostLimit: 100,          // 整体每日限额
  weeklyOpusCostLimit: 500,     // Opus周限额

  // === 新增字段 ===
  platformLimits: {
    claude: {
      enabled: true,            // 是否启用Claude限额
      dailyLimit: 50,          // Claude模型每日限额($)
      weeklyLimit: 300,        // Claude模型每周限额($)
      monthlyLimit: 1200       // Claude模型每月限额($)
    },
    openai: {
      enabled: true,
      dailyLimit: 30,
      weeklyLimit: 200,
      monthlyLimit: 800
    },
    gemini: {
      enabled: false,          // 可选择关闭Gemini限额
      dailyLimit: 20,
      weeklyLimit: 100,
      monthlyLimit: 400
    }
  },

  modelLimits: {
    "gpt-4": {
      enabled: true,
      dailyLimit: 15,          // GPT-4每日限额
      weeklyLimit: 100,
      monthlyLimit: 400
    },
    "claude-opus": {
      enabled: true,
      dailyLimit: 25,          // Claude Opus每日限额
      weeklyLimit: 150,
      monthlyLimit: 600
    }
  }
}
```

### 3.2 Redis存储结构扩展
```
# 现有结构（保持不变）
usage:daily:{keyId}:{YYYY-MM-DD}
  - cost: 总费用
  - requests: 请求数
  - tokens: token数

# 新增：按平台费用统计
usage:daily:{keyId}:{YYYY-MM-DD}
  - claude_cost: Claude平台费用
  - openai_cost: OpenAI平台费用
  - gemini_cost: Gemini平台费用
  - model_gpt-4_cost: GPT-4模型费用
  - model_claude-opus_cost: Claude Opus模型费用
```

## 4. 接口设计

### 4.1 API Key管理接口修改
```javascript
// POST /admin/api-keys - 创建API Key
{
  // 现有字段...
  "platformLimits": {
    "claude": {"enabled": true, "dailyLimit": 50},
    "openai": {"enabled": true, "dailyLimit": 30}
  },
  "modelLimits": {
    "gpt-4": {"enabled": true, "dailyLimit": 15}
  }
}

// PUT /admin/api-keys/{id} - 更新API Key（同上结构）
```

### 4.2 限额状态查询接口
```javascript
// GET /api/v1/key-info - 获取API Key信息（扩展返回）
{
  "limits": {
    "overall": {
      "dailyLimit": 100,
      "currentCost": 45.50,
      "remaining": 54.50
    },
    "platforms": {
      "claude": {
        "enabled": true,
        "dailyLimit": 50,
        "currentCost": 25.30,
        "remaining": 24.70
      }
    },
    "models": {
      "gpt-4": {
        "enabled": true,
        "dailyLimit": 15,
        "currentCost": 8.20,
        "remaining": 6.80
      }
    }
  }
}
```

### 4.3 错误响应扩展
```javascript
// 平台限额超限响应
{
  "error": "Platform daily limit exceeded",
  "message": "已达到Claude平台每日费用限制 ($50)",
  "details": {
    "platform": "claude",
    "currentCost": 50.25,
    "limit": 50.00,
    "resetAt": "2024-01-02T00:00:00.000Z"
  }
}

// 模型限额超限响应
{
  "error": "Model daily limit exceeded",
  "message": "已达到GPT-4模型每日费用限制 ($15)",
  "details": {
    "model": "gpt-4",
    "currentCost": 15.80,
    "limit": 15.00,
    "resetAt": "2024-01-02T00:00:00.000Z"
  }
}
```

## 5. 实现优先级

### 5.1 限额检查顺序
1. **整体限额检查**（现有逻辑，优先级最高）
2. **平台限额检查**（新增，次优先级）
3. **模型限额检查**（新增，最细粒度）

### 5.2 平台识别规则
```javascript
function detectPlatform(model) {
  if (/claude/i.test(model)) return 'claude'
  if (/gpt|o1|davinci/i.test(model)) return 'openai'
  if (/gemini/i.test(model)) return 'gemini'
  return 'unknown'
}
```

## 6. 用户界面需求

### 6.1 API Key创建/编辑界面
- **平台限额配置区块**
  - 复选框启用/禁用各平台
  - 输入框设置每日/每周/每月限额
  - 快速设置按钮（如$50、$100等）

- **模型限额配置区块**
  - 下拉选择模型类型
  - 动态添加/删除模型限额配置
  - 常用模型快捷配置

### 6.2 API Key列表界面
- **限额状态显示**
  - 进度条显示各维度限额使用情况
  - 颜色编码（绿色正常、黄色警告、红色超限）
  - 悬浮提示显示详细信息

### 6.3 使用统计界面
- **按平台费用统计图表**
- **按模型费用统计图表**
- **限额使用趋势分析**

## 7. 技术实现要点

### 7.1 核心文件修改清单
- `src/services/apiKeyService.js` - API Key管理逻辑
- `src/middleware/auth.js` - 限额验证中间件
- `src/models/redis.js` - 数据存储和统计
- `src/routes/admin.js` - 管理接口
- `web/admin-spa/src/components/apikeys/` - 前端组件

### 7.2 数据库迁移
- 为现有API Key记录添加新字段默认值
- 创建数据迁移脚本处理历史数据

### 7.3 兼容性保证
- 新字段设置合理默认值
- 渐进式启用新功能
- 保持现有API响应格式

## 8. 测试用例设计

### 8.1 功能测试
- 平台限额正常工作验证
- 模型限额正常工作验证
- 多重限额组合场景测试
- 限额重置时间测试

### 8.2 边界测试
- 限额为0的处理
- 负数限额的处理
- 未知平台/模型的处理
- 并发请求的限额计算

### 8.3 性能测试
- 限额检查性能影响
- Redis读写性能影响
- 大量API Key的扩展性

## 9. 上线计划

### 9.1 开发阶段
1. **Phase 1**: 后端核心逻辑开发
2. **Phase 2**: 前端界面开发
3. **Phase 3**: 集成测试和优化

### 9.2 部署策略
- 灰度发布，逐步开放新功能
- 提供配置开关控制功能启用
- 准备回滚方案

---

**文档版本**: v1.0
**创建时间**: 2025年9月15日03:15:48
**最后更新**: 2025年9月15日03:15:48